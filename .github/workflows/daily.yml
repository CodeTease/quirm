name: Daily Docker Image Health Check

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  sanity-check:
    name: Pull & Test Latest Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Pull Docker Image
        run: docker pull ghcr.io/codetease/quirm:latest

      - name: Start Container
        run: |
          docker run -d \
            --name quirm-daily-test \
            -p 8080:8080 \
            -e S3_ENDPOINT="http://localhost:9000" \
            -e S3_BUCKET="test-bucket" \
            -e S3_ACCESS_KEY="dummy-access" \
            -e S3_SECRET_KEY="dummy-secret" \
            -e S3_REGION="auto" \
            ghcr.io/codetease/quirm:latest

      - name: Wait for Startup
        run: sleep 5

      - name: Check Health (Expect 400)
        run: |
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/)
          
          echo "Server responded with HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 400 ]; then
            echo "✅ Health Check Passed! Server is up (Received expected 400 Bad Request for root path)."
            exit 0
          else
            echo "❌ Health Check Failed! Unexpected status code: $HTTP_CODE"
            echo "--- Container Logs ---"
            docker logs quirm-daily-test
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: docker rm -f quirm-daily-test